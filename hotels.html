
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Hôtels Disponibles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    h2 { text-align: center; }
    .hotel { border: 1px solid #ccc; border-radius: 10px; padding: 10px; margin: 10px 0; text-align: center; }
    .hotel img { max-width: 100%; border-radius: 10px; }
    button { margin-top: 10px; padding: 8px 15px; border: none; border-radius: 5px; background: green; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Nos Hôtels</h2>
  <div id="hotelList"></div>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();

    async function loadHotels() {
      const snap = await db.collection("hotels").get();
      const list = document.getElementById("hotelList");
      list.innerHTML = "";

      snap.forEach(doc => {
        const hotel = doc.data();
        const div = document.createElement("div");
        div.className = "hotel";
        div.innerHTML = `
          <img src="${hotel.imageUrl}" alt="${hotel.name}">
          <h3>${hotel.name}</h3>
          <p>Prix: $${hotel.price}</p>
          <p>Rendement: ${(hotel.dailyRate * 100).toFixed(2)}% / jour</p>
          <p>Durée: ${hotel.durationDays} jours</p>
          <p>Chambres disponibles: ${hotel.rooms}</p>
          <button onclick="buyHotel('${doc.id}', '${hotel.name}', ${hotel.price}, ${hotel.dailyRate}, ${hotel.durationDays}, '${hotel.imageUrl}')">Acheter</button>
        `;
        list.appendChild(div);
      });
    }

    async function buyHotel(hotelId, name, price, rate, duration, imageUrl) {
      const user = auth.currentUser;
      if (!user) {
        alert("Veuillez vous connecter !");
        return;
      }

      const userRef = db.collection("users").doc(user.uid);
      const userDoc = await userRef.get();
      const balance = userDoc.data().balanceAvailable || 0;

      if (balance < price) {
        alert("❌ Solde insuffisant !");
        return;
      }

      // Déduire solde
      await userRef.update({
        balanceAvailable: firebase.firestore.FieldValue.increment(-price)
      });

      // Ajouter hôtel à l’utilisateur
      const expiresAt = new Date();
      expiresAt.setDate(expiresAt.getDate() + duration);

      await userRef.collection("myHotels").add({
        hotelId, name, price, dailyRate: rate,
        acquiredAt: firebase.firestore.FieldValue.serverTimestamp(),
        expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
        lastProfitAt: null,
        imageUrl
      });

      // Transaction
      await userRef.collection("transactions").add({
        type: "purchase",
        amount: price,
        hotelName: name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert("✅ Achat réussi !");
    }

    loadHotels();
  </script>
</body>
</html>

  
