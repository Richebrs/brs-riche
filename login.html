<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Mon Profil - BRS Riche</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#0d47a1,#1565c0);margin:0;padding:0;}
  .container{max-width:450px;margin:auto;padding:40px 20px;}
  .card{background:#fff;padding:28px;border-radius:16px;box-shadow:0 8px 25px rgba(0,0,0,0.2);}
  h1{text-align:center;color:#0d47a1;margin-bottom:20px;}
  .form-group{margin-bottom:18px;}
  label{font-weight:bold;display:block;margin-bottom:6px;}
  input{width:100%;padding:12px;border:1px solid #ccc;border-radius:10px;font-size:1em;}
  button{width:100%;padding:14px;background:#0d47a1;color:#fff;border:none;border-radius:12px;font-size:1em;font-weight:bold;cursor:pointer;transition:.3s;}
  button:hover{background:#1565c0;}
  .msg{margin-top:15px;padding:10px;border-radius:8px;text-align:center;display:none;}
  .success{background:#e8f5e9;color:#2e7d32;}
  .error{background:#ffebee;color:#c62828;}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Mon Profil</h1>
    <form id="profileForm">
      <div class="form-group">
        <label>Nom d’utilisateur</label>
        <input type="text" id="username" required>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" required>
      </div>
      <button type="submit">Mettre à jour</button>
    </form>
    <div id="msgBox" class="msg"></div>
    <div style="text-align:center;margin-top:15px;">
      <a href="dashboard.html">⬅ Retour au Dashboard</a>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDQ2UWK115OXfThwaGfetIUSPPz_Ry78BA",
  authDomain: "brs-riche.firebaseapp.com",
  projectId: "brs-riche",
  storageBucket: "brs-riche.appspot.com",
  messagingSenderId: "44338076148",
  appId: "1:44338076148:web:b0c32d6caa12221fe601a1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const form = document.getElementById("profileForm");
const msgBox = document.getElementById("msgBox");

// Charger infos actuelles
auth.onAuthStateChanged(async user=>{
  if(!user){ window.location.href="login.html?v="+Date.now(); return; }
  const snap = await db.collection("users").doc(user.uid).get();
  if(snap.exists){
    document.getElementById("username").value = snap.data().username || "";
    document.getElementById("email").value = user.email || "";
  }
});

// Mise à jour
form.addEventListener("submit", async e=>{
  e.preventDefault(); msgBox.style.display="none";
  const user = auth.currentUser;
  if(!user) return;

  const username = document.getElementById("username").value.trim();
  const email = document.getElementById("email").value.trim();

  try{
    // Mise à jour email dans Firebase Auth
    await user.updateEmail(email);

    // Mise à jour Firestore
    await db.collection("users").doc(user.uid).update({
      username: username,
      email: email,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showMsg("✅ Profil mis à jour avec succès.","success");
  }catch(err){
    if(err.code==="auth/requires-recent-login"){
      showMsg("⚠️ Veuillez vous reconnecter pour changer l'email.","error");
    }else{
      showMsg("❌ Erreur : "+err.message,"error");
    }
  }
});

function showMsg(txt,type){
  msgBox.innerText=txt;
  msgBox.className="msg "+type;
  msgBox.style.display="block";
}

// 🔥 Anti-cache automatique (force reload)
if("serviceWorker" in navigator){navigator.serviceWorker.getRegistrations().then(regs=>{regs.forEach(r=>r.unregister());});}
</script>
</body>
</html>
