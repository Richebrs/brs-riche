
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Connexion - BRS Riche</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#0d47a1,#1565c0);margin:0;padding:0;}
.container{max-width:420px;margin:auto;padding:40px 20px;}
.card{background:#fff;padding:32px;border-radius:16px;box-shadow:0 8px 25px rgba(0,0,0,0.2);}
.logo{text-align:center;margin-bottom:10px;}
.logo img{width:80px;height:80px;}
h1{text-align:center;color:#0d47a1;margin-bottom:20px;}
.form-group{margin-bottom:18px;}
label{font-weight:bold;display:block;margin-bottom:6px;}
input{width:100%;padding:12px;border:1px solid #ccc;border-radius:10px;font-size:1em;}
button{width:100%;padding:14px;background:#0d47a1;color:#fff;border:none;border-radius:12px;font-size:1em;font-weight:bold;cursor:pointer;transition:.3s;}
button:hover{background:#1565c0;}
.link{text-align:center;margin-top:16px;font-size:.9em;}
.link a{color:#0d47a1;font-weight:bold;text-decoration:none;}
.msg{margin-top:15px;padding:10px;border-radius:8px;text-align:center;display:none;}
.success{background:#e8f5e9;color:#2e7d32;}
.error{background:#ffebee;color:#c62828;}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="logo"><img src="logo.png" alt="BRS Riche"></div>
    <h1>Se connecter</h1>
    <form id="loginForm">
      <div class="form-group">
        <label>Nom d’utilisateur ou Email</label>
        <input type="text" id="userInput" required>
      </div>
      <div class="form-group">
        <label>Mot de passe</label>
        <input type="password" id="password" required>
      </div>
      <button type="submit">Connexion</button>
    </form>
    <div id="msgBox" class="msg"></div>
    <div class="link">
      <p>Pas encore inscrit ? <a href="register.html?v=<?php echo time();?>">Créer un compte</a></p>
      <p><a href="reset.html?v=<?php echo time();?>">Mot de passe oublié ?</a></p>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDQ2UWK115OXfThwaGfetIUSPPz_Ry78BA",
  authDomain: "brs-riche.firebaseapp.com",
  projectId: "brs-riche",
  storageBucket: "brs-riche.appspot.com",
  messagingSenderId: "44338076148",
  appId: "1:44338076148:web:b0c32d6caa12221fe601a1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const form = document.getElementById("loginForm");
const msgBox = document.getElementById("msgBox");

form.addEventListener("submit", async e=>{
  e.preventDefault(); msgBox.style.display="none";
  const input = document.getElementById("userInput").value.trim();
  const pass = document.getElementById("password").value;

  try{
    let emailToUse = input;

    // Si ce n'est pas un email → on suppose username
    if(!input.includes("@")){
      const usernameDoc = await db.collection("usernames").doc(input).get();
      if(!usernameDoc.exists){
        return showMsg("⚠️ Nom d’utilisateur introuvable.","error");
      }
      const uid = usernameDoc.data().uid;
      const userDoc = await db.collection("users").doc(uid).get();
      if(!userDoc.exists){
        return showMsg("⚠️ Utilisateur introuvable.","error");
      }
      emailToUse = userDoc.data().email;
    }

    await auth.signInWithEmailAndPassword(emailToUse, pass);
    showMsg("✅ Connexion réussie ! Redirection...", "success");
    setTimeout(()=>window.location.href="dashboard.html?v="+Date.now(),1200);

  }catch(err){
    if(err.code==="auth/user-not-found") showMsg("⚠️ Utilisateur introuvable.","error");
    else if(err.code==="auth/wrong-password") showMsg("⚠️ Mot de passe incorrect.","error");
    else showMsg("❌ Erreur : "+err.message,"error");
  }
});

function showMsg(txt,type){
  msgBox.innerText=txt;
  msgBox.className="msg "+type;
  msgBox.style.display="block";
}
</script>
</body>
</html>

  
